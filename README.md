# Ping test failed event script

[![N|Solid](https://upload.wikimedia.org/wikipedia/commons/3/31/Juniper_Networks_logo.svg)](https://www.juniper.net/us/en.html)

## Overview

This repository will provide a Python-less Event Script for Juniper Networks devices running JunOS.

This example creates an event policy named disable-interface-on-ping-failure. The event policy is configured so that the eventd process listens for PING_TEST_FAILED events generated by a specific RPM probe and associated with the ge-0/3/1 interface. If three PING_TEST_FAILED events occur for the given interface within a 60-second interval, the event policy executes a change configuration action. The event policy configuration commands administratively disable the interface.

To test the event policy, the example configures an RPM probe that pings the IP address associated with the ge-0/3/1 interface. In this example, the ge-0/3/1.0 interface is configured with the IPv4 address 10.1.4.1/26. By default, one probe is sent per test, and the example uses a 5-second pause between tests. After three successive probe losses, the RPM probe generates a PING_TEST_FAILED event. Because multiple RPM tests could be running simultaneously, the event policy matches the owner-name and test-name attributes of the received PING_TEST_FAILED events to the RPM probe owner name and test name. When the RPM probe generates three PING_TEST_FAILED events in a 60-second interval, it triggers the event policy, which disables the interface.

This event policy also demonstrates how to restrict the execution of the same configuration change multiple times because of occurrences of the same event or correlated events. In this example, the within 60 trigger on 3 statement specifies that the configuration change is only triggered on the third occurrence of a PING_TEST_FAILED event within a 60-second interval. The trigger until 4 statement specifies that subsequent occurrences of the PING_TEST_FAILED event should not cause the event policy to re-trigger.

NOTE: If you only configure the trigger on 3 condition, the commit operation might go into a loop. The combination of trigger on 3 and trigger until 4 prevents the event policy from repeatedly making the same configuration change.

## ⚙️ Configuration

### Configuring the RPM probe

1. Create an RPM probe named ping-probe-test with owner icmp-ping-probe
2. Configure the RPM probe to send the ICMP echo requests to the ge-0/3/1 interface at IP address 10.1.4.1.
3. Configure a 5-second pause between test windows.
4. Configure the RPM probe threshold so that the PING_TEST_FAILED event is triggered after three successive probe losses.
5. Configure a new log file at the [edit system syslog] hierarchy level to record syslog events of facility daemon and severity info. This captures the events sent during the probe tests.

#### Set RPM configuration commands

``` yaml
set services rpm probe icmp-ping-probe test ping-probe-test probe-type icmp-ping
set services rpm probe icmp-ping-probe test ping-probe-test target address 10.1.4.1
set services rpm probe icmp-ping-probe test ping-probe-test test-interval 5
set services rpm probe icmp-ping-probe test ping-probe-test thresholds successive-loss 3
set system syslog file syslog-event-daemon-info daemon info
```

#### Resulting RPM configuration

``` yaml
[edit]
services {
    rpm {
        probe icmp-ping-probe {
            test ping-probe-test {
                probe-type icmp-ping;
                target address 10.1.4.1;
                test-interval 5;
                thresholds {
                    successive-loss 3;
                }
            }
        }
    }
}
system {
    syslog {
        file syslog-event-daemon-info {
            daemon info;
        }
    }
}
```

### Configuring the Event Policy

1. Create and name the event-policy.
2. Configure the policy to trigger when three PING_TEST_FAILED events occur within 60 seconds.
3. Configure the `within 65 trigger until 4` statement to prevent the policy from re-triggering if more than three PING_TEST_FAILED events occur.
4. Configure the attributes-match statement so that the event policy is only triggered by the PING_TEST_FAILED events generated by the associated RPM probe.
5. Specify the configuration mode commands that are executed if the event policy is triggered.
6. Configure each command on a single line, enclose the command string in quotes, and specify the complete statement path.
7. Configure the log option with a comment describing the configuration changes.
8. The comment is added to the commit logs after a successful commit operation is made through the associated event policy.
9. (Optional) If you have dual Routing Engines, configure the synchronize option to commit the configuration on both Routing Engines.
Include the `force` option to force the commit on the other Routing Engine, ignoring any warnings. This example does not configure the synchronize and force options.
10. (Optional) Configure the username under whose privileges the configuration changes and commit are made.
*If you do not specify a username, the action is executed as user `root`.*

#### Set Event Options configuration commands

``` yaml
set event-options policy disable-on-ping-failure events ping_test_failed
set event-options policy disable-on-ping-failure within 60 trigger on
set event-options policy disable-on-ping-failure within 60 trigger 3
set event-options policy disable-on-ping-failure within 65 trigger until
set event-options policy disable-on-ping-failure within 65 trigger 4
set event-options policy disable-on-ping-failure attributes-match ping_test_failed.test-owner matches icmp-ping-probe
set event-options policy disable-on-ping-failure attributes-match ping_test_failed.test-name matches ping-probe-test
set event-options policy disable-on-ping-failure then change-configuration commands "set interfaces ge-0/3/1 disable"
set event-options policy disable-on-ping-failure then change-configuration user-name bsmith
set event-options policy disable-on-ping-failure then change-configuration commit-options log "updating configuration from event policy disable-on-ping-failure"
```

#### Resulting Event Options configuration

``` yaml
[edit event-options]
policy disable-interface-on-ping-failure {
    events ping_test_failed;
    within 60 {
        trigger on 3;
    }
    within 65 {
        trigger until 4;
    }
    attributes-match {
        ping_test_failed.test-owner matches icmp-ping-probe;
        ping_test_failed.test-name matches ping-probe-test;
    }
    then {
        change-configuration {
            commands {
                "set interfaces ge-0/3/1 disable";
            }
            user-name bsmith;
            commit-options {
                log "updating configuration from event policy disable-interface-on-ping-failure";
            }
        }
    }
}

```

## 🚀 Execution Verification

### Verifying the Events

To manually test the event policy, take the ge-0/3/1 interface offline until three PING_TEST_FAILED events are generated.

Review the configured syslog file. Verify that the RPM probe generates a PING_TEST_FAILED event after successive lost probes.

``` yaml
bsmith@R1> show log syslog-event-daemon-info
Oct  7 15:48:54  R1 rmopd[1345]: PING_TEST_COMPLETED: pingCtlOwnerIndex = icmp-ping-probe, pingCtlTestName = ping-probe-test
Oct  7 15:49:54  R1 rmopd[1345]: PING_TEST_COMPLETED: pingCtlOwnerIndex = icmp-ping-probe, pingCtlTestName = ping-probe-test
...
Oct  7 15:52:54  R1 rmopd[1345]: RMOPD_ICMP_SENDMSG_FAILURE: sendmsg(ICMP): No route to host
Oct  7 15:52:54  R1 rmopd[1345]: PING_PROBE_FAILED: pingCtlOwnerIndex = icmp-ping-probe, pingCtlTestName = ping-probe-test
Oct  7 15:52:54  R1 rmopd[1345]: PING_TEST_FAILED: pingCtlOwnerIndex = icmp-ping-probe, pingCtlTestName = ping-probe-test
Oct  7 15:52:57  R1 rmopd[1345]: PING_TEST_FAILED: pingCtlOwnerIndex = icmp-ping-probe, pingCtlTestName = ping-probe-test
Oct  7 15:53:00  R1 rmopd[1345]: PING_TEST_FAILED: pingCtlOwnerIndex = icmp-ping-probe, pingCtlTestName = ping-probe-test
```

### Verifying the Commit

Verify that the event policy commit operation was successful by reviewing the commit log and the messages log file.

Issue the show system commit operational mode command to view the commit log.

``` yaml
bsmith@R1> show system commit
0   2011-10-07 15:53:00 PDT by bsmith via junoscript
    updating configuration from event policy disable-interface-on-ping-failure
1   2011-09-02 14:16:44 PDT by admin via netconf
2   2011-07-08 14:33:46 PDT by root via other
```

Review the messages log file.

``` yaml
bsmith@R1> show log messages | last 20
Oct  7 15:52:54  R1 rmopd[1345]: RMOPD_ICMP_SENDMSG_FAILURE: sendmsg(ICMP): No route to host
Oct  7 15:53:00  R1 file[9972]: UI_COMMIT: User 'bsmith' requested 'commit' operation (comment: updating configuration from event policy disable-interface-on-ping-failure)
Oct  7 15:53:02  R1 eventd: EVENTD_CONFIG_CHANGE_SUCCESS: Configuration change successful: while executing policy disable-interface-on-ping-failure with user bsmith privileges
```

The output from the show system commit operational mode command and the messages log file verify that Junos OS executed the configured event policy action to modify and commit the configuration. The commit operation, which was made through the event policy under the privileges of the user bsmith at the given date and time, was successful. The show system commit output and messages log file reference the commit comment specified in the log statement at the [edit event-options policy disable-interface-on-ping-failure then change-configuration commit-options] hierarchy level.

### Verifying the Configuration Changes

Verify the configuration changes by reviewing the [edit interfaces ge-0/3/1] hierarchy level of the configuration.

``` yaml
bsmith@R1> show configuration interfaces ge-0/3/1
disable;
unit 0 {
    family inet {
        address 10.1.4.1/26;
    }
}
```

The ge-0/3/1 configuration hierarchy was modified through the event policy to add the disable statement.

### Verifying the Status of the Interface

Review the output of the show interfaces ge-0/3/1 operational mode command after the configuration change takes place.

Issue the show interfaces ge-0/3/1 operational mode command. After the event policy configuration change action disables the interface, the status changes from "Enabled" to "Administratively down".

``` yaml
bsmith@R1> show interfaces ge-0/3/1
Physical interface: ge-0/3/1, Administratively down, Physical link is Down
  Interface index: 142, SNMP ifIndex: 531
```
